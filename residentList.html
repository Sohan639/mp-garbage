<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Mauxi Panchayat</title>
    <!-- CSS files -->
    <link href="./dist/css/tabler.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-flags.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-payments.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-vendors.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/demo.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/datatable/dataTables.css" rel="stylesheet"/>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
      	--tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      body {
      	font-feature-settings: "cv03", "cv04", "cv11";
      }

      /* body > div.page > div.page-wrapper > div.page-body > div > div > div > div > div.tableContainer > div.card-body.border-bottom.py-3 > div > div.ms-auto.text-secondary > div > div {
        width: 225px !important;
        min-width: 0px !important;
      } */

    </style>
  </head>
  <body >
    <script src="./dist/js/demo-theme.min.js?1692870487"></script>
    <div class="page">
      <!-- Navbar -->
      <div id="horizontal-menu-placeholder"></div>
      <div class="page-wrapper">
        <!-- Page header -->
        <div class="page-header d-print-none">
          <div class="container">
            <div class="row g-2 align-items-center">
              <!-- Page title actions -->
              <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                  <a id="exportBtn1" onclick="exportTable()" class="btn btn-primary d-none d-sm-inline-block">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-download"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" /><path d="M7 11l5 5l5 -5" /><path d="M12 4l0 12" /></svg>
                    Export
                  </a>
                  <a id="exportBtn2" class="btn btn-primary d-sm-none btn-icon"  aria-label="Export">
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-download"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" /><path d="M7 11l5 5l5 -5" /><path d="M12 4l0 12" /></svg>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Page body -->
        <div class="page-body">
          <div class="container">
            <div class="row row-deck row-cards">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Resident List</h3>
                    
                  </div>

                  <div id="tableLoader" class="container container-slim py-4">
                    <div class="text-center">
                      <div class="text-secondary mb-3">Loading...</div>
                      <div class="progress progress-sm">
                        <div class="progress-bar progress-bar-indeterminate"></div>
                      </div>
                    </div>
                  </div>

                  <div class="tableContainer d-none">
                    <div class="card-body border-bottom py-3">
                      <div class="row">
                        <div class="col-md-4 ms-auto text-secondary">
                          <div class="row">
                            <div class="col-6 text-md-end" style="line-height: 3;">
                              Search by House no.:
                            </div>
                            <div class="col-6">
                              <!-- <input type="text" id="hnoSearch" class="form-control form-control-sm" aria-label="Search House No."> -->
                              <select id="hnoSearch" class="form-select" multiple></select>
                            </div>
                          </div>
                        </div>

                        <div class="col-md-4 ms-auto text-secondary">
                          <div class="row">
                            <div class="col-6 text-md-end" style="line-height: 3;">
                              Search by Aadhar no.:
                            </div>
                            <div class="col-6">
                              <!-- <input type="text" id="hnoSearch" class="form-control form-control-sm" aria-label="Search House No."> -->
                              <select id="aadharSearch" class="form-select" multiple></select>
                            </div>
                          </div>
                        </div>

                        <div class="col-md-4 ms-auto text-secondary">
                          <div class="row">
                            <div class="col-6 text-md-end" style="line-height: 3;">
                              Search:
                            </div>
                            <div class="col-6">
                              <input type="text" id="customSearch" class="form-control" aria-label="Search">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table id="residentTable" class="table card-table table-vcenter text-nowrap datatable">
                        <thead>
                          <tr>
                            <th>Resident Name</th>
                            <th>House No.</th>
                            <th>Address</th>
                            <th>Contact</th>
                            <th>Aadhar No.</th>
                            <th>Gender</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="noRecordsContainer d-none h3" style="text-align: center; margin-top: 16px;">
                    No records found.
                </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="footer-placeholder"></div>
      </div>
    </div>
  
    <!-- Libs JS -->
    <script src="./dist/libs/apexcharts/dist/apexcharts.min.js?1692870487" defer></script>
    <script src="./dist/libs/jsvectormap/dist/js/jsvectormap.min.js?1692870487" defer></script>
    <script src="./dist/libs/jsvectormap/dist/maps/world.js?1692870487" defer></script>
    <script src="./dist/libs/jsvectormap/dist/maps/world-merc.js?1692870487" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <!-- Tabler Core -->
    <script src="./dist/js/tabler.min.js?1692870487" defer></script>
    <script src="./dist/js/demo.min.js?1692870487" defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.1/axios.min.js"></script>
    <script type="text/javascript" src="./commonFunction/commonFunction.js"></script>

    <script src="./dist/js/configUrl.js"></script>
    <script src="./dist/js/menu-footer.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
          const userId = localStorage.getItem('userId');
          if (!userId) {
                  window.location = config_url.frontendBaseURL;
              }
          });
    </script>

    <script>
      $(document).ready(function () {

        const role = localStorage.getItem('role');
        if(role != "admin"){
          $('#exportBtn1').attr('style', 'display:none !important');
          $('#exportBtn2').attr('style', 'display:none !important');
        }

        let residentList;
        // Function to call getResidentDetailList api
        async function getResidentListing(){
          try {
            const listing = await getAllListing('getResidentDetailList');
            residentList = listing.data;
            const tableBody = $("#residentTable tbody");
            // Clear the table before populating
            tableBody.empty();

            if(listing.data.length > 0){
              $('.tableContainer').removeClass('d-none');
              $('.noRecordsContainer').addClass('d-none');
            } else {
              $('.tableContainer').addClass('d-none');
              $('.noRecordsContainer').removeClass('d-none');
            }

            // Loop through each record and append a table row
            $.each(listing.data, function(index, record) {
              const row = `
                <tr>
                  <td><span class="text-secondary">${record.name || ""}</span></td>
                  <td><a href="#" class="text-reset" tabindex="-1">${record.houseNo || ""}</a></td>
                  <td><div style="
                      width: 200px; 
                      white-space: nowrap;
                      text-overflow: ellipsis;
                      overflow: hidden;">
                      ${record.address || ""}</div>
                  </td>
                  <td>${record.contact || ""}</td>
                  <td>${record.aadharNo || ""}</td>
                  <td>${record.gender || ""}</td>
                  <td><a onclick="goToView(${record.citizenId})" class="btn btn-primary">View</a></td>
                </tr>
              `;
              tableBody.append(row);
            });

            // Initialize DataTables with pagination, sorting, and search functionality
            const dataTable = $(".datatable").DataTable({
              paging: true,
              pageLength: 10, // Show 10 entries per page
              lengthChange: false, // Hide "entries per page" dropdown
              searching: true, // Enable search
              ordering: true, // Enable sorting
              info: true, // Show "Showing x to y of z entries"
              autoWidth: false, // Keep the layout intact
              language: {
                search: "_INPUT_", // Customize the search input
                searchPlaceholder: "Search...",
                paginate: {
                  previous: "< prev", // Change 'Previous' text
                  next: "next >",    // Change 'Next' text
                },
              },
            });

            // Initialize Tom Select for House No. filtering
            const tomSelect = new TomSelect('#hnoSearch', {
              plugins: ['remove_button'], // Allows tags to be removed
              create: true,              // Allows new tags to be created
              persist: false,            // Prevents duplicate tags
              onChange: function (selectedHouseNos) {
                const selectedAadharNos = aadharSelect.getValue();
                filterTable(dataTable, selectedHouseNos, selectedAadharNos, $('#customSearch').val());
              },
            });

            // Initialize Tom Select for Aadhar No. filtering
            const aadharSelect = new TomSelect('#aadharSearch', {
              plugins: ['remove_button'], // Allows tags to be removed
              create: true,              // Allows new tags to be created
              persist: false,            // Prevents duplicate tags
              onChange: function (selectedAadharNos) {
                const selectedHouseNos = tomSelect.getValue(); // Get selected house numbers
                const searchValue = $('#customSearch').val();  // Get the custom search value
                filterTable(dataTable, selectedHouseNos, selectedAadharNos, searchValue);
              },
            });

            // Add custom search functionality
            $('#customSearch').keyup(function () {
              const searchValue = $(this).val();
              const selectedHouseNos = tomSelect.getValue();    // Get selected house numbers
              const selectedAadharNos = aadharSelect.getValue(); // Get selected Aadhar numbers
              filterTable(dataTable, selectedHouseNos, selectedAadharNos, searchValue);
            });

            // $('#customSearch').keyup(function(){
            //   dataTable.search($(this).val()).draw();
            // })
            $('#tableLoader').addClass('d-none');
          } catch (error) {
            console.error(error)
            $('#tableLoader').addClass('d-none');
          }
        }

        function filterTable(dataTable, selectedHouseNos, selectedAadharNos, searchValue) {
          const filteredData = residentList.filter(item => {
            const matchesHouseNo = selectedHouseNos.length === 0 || selectedHouseNos.includes(item.houseNo);
            const matchesAadharNo = selectedAadharNos.length === 0 || selectedAadharNos.includes(item.aadharNo);
            const matchesSearch = !searchValue || Object.values(item).some(value => 
              value && value.toString().toLowerCase().includes(searchValue.toLowerCase())
            );

            return matchesHouseNo && matchesAadharNo && matchesSearch;
          });

          // Clear the DataTable and re-populate it
          dataTable.clear();
          filteredData.forEach(record => {
            dataTable.row.add([
              `<span class="text-secondary">${record.name || ''}</span>`, // Handle undefined/null gracefully
              `<a href="#" class="text-reset" tabindex="-1">${record.houseNo || ''}</a>`,
              record.address || '',
              record.contact || '',
              record.aadharNo || '',
              record.gender || '',
              record.createdBy || '',
              `<a onclick="goToView(${record.citizenId})" class="btn btn-primary">View</a>`
            ]);
          });
          dataTable.draw();
        }

        // Function to export api response data in excel form
        window.exportTable =  function() {
          if (!residentList || residentList.length === 0) {
            alert("No data to export!");
            return;
          }

          // Prepare the data for export
          const rows = [["House No.", "Name", "Gender", "Date of birth", "Contact", "Aadhar No.", "Pan card", "Driving license", "Address", "Alternate contact", "Email", "Annual income", "Electricity bill No.", "Water bill No.", "Passport No.", "Created at", "Created by"]];

          residentList.forEach(item => {
            rows.push([
              item.houseNo,
              item.name,
              item.gender || "-",
              item.dob,
              item.contact,
              item.aadharNo || "-",
              item.panCard || "-",
              item.drivingLicense || "-",
              item.address,
              item.altContact || "-",
              item.email || "-",
              item.annualIncome || "-",
              item.electricityBill || "-",
              item.waterBill || "-",
              item.passportNo || "-",
              item.createdAt || "-",
              item.createdBy || "-",
            ]);
          });

          // Convert rows to a worksheet
          const worksheet = XLSX.utils.aoa_to_sheet(rows);

          // Create a workbook
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Resident");

          // Export the workbook
          XLSX.writeFile(workbook, "resident-list.xlsx");
        }

        window.goToView = function(id){
          window.location.href=`viewhousesurvey.html?value=${id}&location=resident`
        }

        getResidentListing();
      });
    </script>

  </body>
</html>